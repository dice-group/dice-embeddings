

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dicee.read_preprocess_save_load_kg.util &mdash; DICE Embeddings 0.1.3.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=677a9ea0" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../_static/theme.css?v=ea877efc" />
      <link rel="stylesheet" type="text/css" href="../../../_static/theme_tweak.css?v=f0ad19f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=677a9ea0" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=c6726a90"></script>
      <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            DICE Embeddings
              <img src="../../../_static/dicee_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/main.html">Dicee Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/main.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/main.html#download-knowledge-graphs">Download Knowledge Graphs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/main.html#knowledge-graph-embedding-models">Knowledge Graph Embedding Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/main.html#how-to-train">How to Train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/main.html#creating-an-embedding-vector-database">Creating an Embedding Vector Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/main.html#answering-complex-queries">Answering Complex Queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/main.html#predicting-missing-links">Predicting Missing Links</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/main.html#downloading-pretrained-models">Downloading Pretrained Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/main.html#how-to-deploy">How to Deploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/main.html#docker">Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/main.html#coverage-report">Coverage Report</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/main.html#how-to-cite">How to cite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autoapi/dicee/index.html">dicee</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">DICE Embeddings</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">dicee.read_preprocess_save_load_kg.util</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for dicee.read_preprocess_save_load_kg.util</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">polars</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">cpu_count</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<div class="viewcode-block" id="polars_dataframe_indexer">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.polars_dataframe_indexer">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">polars_dataframe_indexer</span><span class="p">(</span><span class="n">df_polars</span><span class="p">:</span><span class="n">polars</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">idx_entity</span><span class="p">:</span><span class="n">polars</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">idx_relation</span><span class="p">:</span><span class="n">polars</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">polars</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     Replaces &#39;subject&#39;, &#39;relation&#39;, and &#39;object&#39; columns in the input Polars DataFrame with their corresponding index values</span>
<span class="sd">     from the entity and relation index DataFrames.</span>

<span class="sd">     This function processes the DataFrame in three main steps:</span>
<span class="sd">     1. Replace the &#39;relation&#39; values with the corresponding index from `idx_relation`.</span>
<span class="sd">     2. Replace the &#39;subject&#39; values with the corresponding index from `idx_entity`.</span>
<span class="sd">     3. Replace the &#39;object&#39; values with the corresponding index from `idx_entity`.</span>

<span class="sd">     Parameters:</span>
<span class="sd">     -----------</span>
<span class="sd">     df_polars : polars.DataFrame</span>
<span class="sd">         The input Polars DataFrame containing columns: &#39;subject&#39;, &#39;relation&#39;, and &#39;object&#39;.</span>

<span class="sd">     idx_entity : polars.DataFrame</span>
<span class="sd">         A Polars DataFrame that contains the mapping between entity names and their corresponding indices.</span>
<span class="sd">         Must have columns: &#39;entity&#39; and &#39;index&#39;.</span>

<span class="sd">     idx_relation : polars.DataFrame</span>
<span class="sd">         A Polars DataFrame that contains the mapping between relation names and their corresponding indices.</span>
<span class="sd">         Must have columns: &#39;relation&#39; and &#39;index&#39;.</span>

<span class="sd">     Returns:</span>
<span class="sd">     --------</span>
<span class="sd">     polars.DataFrame</span>
<span class="sd">         A DataFrame with the &#39;subject&#39;, &#39;relation&#39;, and &#39;object&#39; columns replaced by their corresponding indices.</span>

<span class="sd">     Example Usage:</span>
<span class="sd">     --------------</span>
<span class="sd">     &gt;&gt;&gt; df_polars = pl.DataFrame({</span>
<span class="sd">             &quot;subject&quot;: [&quot;Alice&quot;, &quot;Bob&quot;, &quot;Charlie&quot;],</span>
<span class="sd">             &quot;relation&quot;: [&quot;knows&quot;, &quot;works_with&quot;, &quot;lives_in&quot;],</span>
<span class="sd">             &quot;object&quot;: [&quot;Dave&quot;, &quot;Eve&quot;, &quot;Frank&quot;]</span>
<span class="sd">         })</span>
<span class="sd">     &gt;&gt;&gt; idx_entity = pl.DataFrame({</span>
<span class="sd">             &quot;entity&quot;: [&quot;Alice&quot;, &quot;Bob&quot;, &quot;Charlie&quot;, &quot;Dave&quot;, &quot;Eve&quot;, &quot;Frank&quot;],</span>
<span class="sd">             &quot;index&quot;: [0, 1, 2, 3, 4, 5]</span>
<span class="sd">         })</span>
<span class="sd">     &gt;&gt;&gt; idx_relation = pl.DataFrame({</span>
<span class="sd">             &quot;relation&quot;: [&quot;knows&quot;, &quot;works_with&quot;, &quot;lives_in&quot;],</span>
<span class="sd">             &quot;index&quot;: [0, 1, 2]</span>
<span class="sd">         })</span>
<span class="sd">     &gt;&gt;&gt; polars_dataframe_indexer(df_polars, idx_entity, idx_relation)</span>

<span class="sd">     Steps:</span>
<span class="sd">     ------</span>
<span class="sd">     1. Join the input DataFrame `df_polars` on the &#39;relation&#39; column with `idx_relation` to replace the relations with their indices.</span>
<span class="sd">     2. Join on &#39;subject&#39; to replace it with the corresponding entity index using a left join on `idx_entity`.</span>
<span class="sd">     3. Join on &#39;object&#39; to replace it with the corresponding entity index using a left join on `idx_entity`.</span>
<span class="sd">     4. Select only the &#39;subject&#39;, &#39;relation&#39;, and &#39;object&#39; columns to return the final result.</span>
<span class="sd">     &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_polars</span><span class="p">,</span> <span class="n">polars</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx_entity</span><span class="p">,</span> <span class="n">polars</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx_relation</span><span class="p">,</span> <span class="n">polars</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>

    <span class="c1"># Step : Join on &#39;relation&#39; to replace relation with its index</span>
    <span class="n">df_merged</span> <span class="o">=</span> <span class="n">df_polars</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">idx_relation</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;relation&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
    <span class="n">df_merged</span> <span class="o">=</span> <span class="n">df_merged</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">polars</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;subject&quot;</span><span class="p">),</span> <span class="n">polars</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;relation&quot;</span><span class="p">),</span> <span class="n">polars</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;object&quot;</span><span class="p">)])</span>
    <span class="c1"># Step :  Consider Left Table on subject and Right Table on entity with the left join</span>
    <span class="c1"># Returns all rows from the left table, and the matched rows from the right table</span>
    <span class="n">df_merged</span> <span class="o">=</span> <span class="n">df_merged</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">idx_entity</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;subject&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;entity&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
    <span class="n">df_merged</span> <span class="o">=</span> <span class="n">df_merged</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;subject&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;subject&quot;</span><span class="p">})</span>
    <span class="c1"># Step 3: Join on &#39;object&#39; to replace object with its index</span>
    <span class="n">df_final</span> <span class="o">=</span> <span class="n">df_merged</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">idx_entity</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;entity&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
    <span class="n">df_final</span> <span class="o">=</span> <span class="n">df_final</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;object&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">})</span>
    <span class="c1"># Step 4: Select the desired columns</span>
    <span class="n">df_final</span> <span class="o">=</span> <span class="n">df_final</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">polars</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;subject&quot;</span><span class="p">),</span> <span class="n">polars</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;relation&quot;</span><span class="p">),</span> <span class="n">polars</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;object&quot;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">df_final</span></div>



<div class="viewcode-block" id="pandas_dataframe_indexer">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.pandas_dataframe_indexer">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pandas_dataframe_indexer</span><span class="p">(</span><span class="n">df_pandas</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">idx_entity</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">idx_relation</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replaces &#39;subject&#39;, &#39;relation&#39;, and &#39;object&#39; columns in the input Pandas DataFrame with their corresponding index values</span>
<span class="sd">    from the entity and relation index DataFrames.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    df_pandas : pd.DataFrame</span>
<span class="sd">        The input Pandas DataFrame containing columns: &#39;subject&#39;, &#39;relation&#39;, and &#39;object&#39;.</span>

<span class="sd">    idx_entity : pd.DataFrame</span>
<span class="sd">        A Pandas DataFrame that contains the mapping between entity names and their corresponding indices.</span>
<span class="sd">        Must have columns: &#39;entity&#39; and &#39;index&#39;.</span>

<span class="sd">    idx_relation : pd.DataFrame</span>
<span class="sd">        A Pandas DataFrame that contains the mapping between relation names and their corresponding indices.</span>
<span class="sd">        Must have columns: &#39;relation&#39; and &#39;index&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        A DataFrame with the &#39;subject&#39;, &#39;relation&#39;, and &#39;object&#39; columns replaced by their corresponding indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_pandas</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx_entity</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx_relation</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>

    <span class="c1"># Create a dictionary that maps entities to their indices</span>
    <span class="n">entity_to_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">idx_entity</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx_entity</span><span class="p">[</span><span class="s1">&#39;entity&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">df_pandas</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pandas</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">entity_to_index</span><span class="p">)</span>
    <span class="n">df_pandas</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pandas</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">entity_to_index</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">entity_to_index</span>
    <span class="n">relation_to_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">idx_relation</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx_relation</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">df_pandas</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pandas</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">relation_to_index</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">relation_to_index</span>
    <span class="k">return</span> <span class="n">df_pandas</span></div>



<div class="viewcode-block" id="apply_reciprocal_or_noise">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.apply_reciprocal_or_noise">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">apply_reciprocal_or_noise</span><span class="p">(</span><span class="n">add_reciprocal</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">eval_model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add reciprocal triples if conditions are met&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">add_reciprocal</span> <span class="ow">and</span> <span class="n">eval_model</span> <span class="ow">and</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adding reciprocal triples to </span><span class="si">{</span><span class="n">info</span><span class="si">}</span><span class="s1">, e.g. KG:= (s, p, o) union (o, p_inverse, s)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">create_recipriocal_triples</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="timeit">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.timeit">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">timeit</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">timeit_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> took </span><span class="si">{</span><span class="n">total_time</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> seconds &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;| Current Memory Usage </span><span class="si">{</span><span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000000</span><span class="si">:</span><span class="s1"> .5</span><span class="si">}</span><span class="s1"> in MB&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">return</span> <span class="n">timeit_wrapper</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_filter_literal_triples</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove triples with literal values if RDF format detected&quot;&quot;&quot;</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span> <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;polars&quot;</span> <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">&quot;relation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removing triples with literal values...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;polars&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">polars</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;object&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">starts_with</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">df</span>


<div class="viewcode-block" id="read_with_polars">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.read_with_polars">[docs]</a>
<span class="nd">@timeit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">read_with_polars</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">read_only_few</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sample_triples_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">separator</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">polars</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load and Preprocess via Polars&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">separator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;separator cannot be None&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;*** Reading </span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s1"> with Polars ***&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s2">&quot;.zst&quot;</span> <span class="ow">in</span> <span class="n">data_path</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">polars</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">n_rows</span><span class="o">=</span><span class="n">read_only_few</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">polars</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span>
                             <span class="n">has_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">n_rows</span><span class="o">=</span><span class="n">read_only_few</span><span class="p">,</span>
                             <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                             <span class="n">dtypes</span><span class="o">=</span><span class="p">[</span><span class="n">polars</span><span class="o">.</span><span class="n">String</span><span class="p">],</span>
                             <span class="n">new_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;relation&#39;</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">],</span>
                             <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">sample_triples_ratio</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subsampling </span><span class="si">{</span><span class="n">sample_triples_ratio</span><span class="si">}</span><span class="s1"> of input data </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="n">sample_triples_ratio</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">_filter_literal_triples</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;polars&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="read_with_pandas">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.read_with_pandas">[docs]</a>
<span class="nd">@timeit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">read_with_pandas</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">read_only_few</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sample_triples_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">separator</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load and Preprocess via Pandas&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">separator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;separator cannot be None&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;*** Reading </span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s1"> with Pandas ***&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">data_path</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.nt&quot;</span><span class="p">,</span> <span class="s2">&quot;ttl&quot;</span><span class="p">,</span> <span class="s1">&#39;txt&#39;</span><span class="p">,</span> <span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="s1">&#39;zst&#39;</span><span class="p">]:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span>
                         <span class="n">sep</span><span class="o">=</span><span class="n">separator</span><span class="p">,</span>
                         <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">nrows</span><span class="o">=</span><span class="n">read_only_few</span><span class="p">,</span>
                         <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                         <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;relation&#39;</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">],</span>
                         <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;pyarrow&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">read_only_few</span> <span class="ow">and</span> <span class="n">read_only_few</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading only few input data </span><span class="si">{</span><span class="n">read_only_few</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">read_only_few</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">sample_triples_ratio</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subsampling </span><span class="si">{</span><span class="n">sample_triples_ratio</span><span class="si">}</span><span class="s1"> of input data...&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="n">sample_triples_ratio</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">_filter_literal_triples</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;pandas&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="read_from_disk">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.read_from_disk">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_from_disk</span><span class="p">(</span><span class="n">data_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">read_only_few</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">sample_triples_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">separator</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>\
        <span class="o">-&gt;</span><span class="n">Tuple</span><span class="p">[</span><span class="n">polars</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
    <span class="k">assert</span> <span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;backend cannot be None&quot;</span>
    <span class="k">assert</span> <span class="n">separator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;separator cannot be None. Currently </span><span class="si">{</span><span class="n">separator</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="c1"># If path exits</span>
    <span class="k">if</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>
        <span class="c1"># (1) Detect data format</span>
        <span class="n">dformat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">data_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dformat</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ttl&quot;</span><span class="p">,</span> <span class="s2">&quot;owl&quot;</span><span class="p">,</span> <span class="s2">&quot;turtle&quot;</span><span class="p">,</span> <span class="s2">&quot;rdf/xml&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">backend</span> <span class="o">!=</span> <span class="s2">&quot;rdflib&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Data with **</span><span class="si">{</span><span class="n">dformat</span><span class="si">}</span><span class="s2">** format cannot be read via --backend pandas or polars. Use --backend rdflib&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;pandas&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">read_with_pandas</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">read_only_few</span><span class="p">,</span> <span class="n">sample_triples_ratio</span><span class="p">,</span> <span class="n">separator</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;polars&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">read_with_polars</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">read_only_few</span><span class="p">,</span> <span class="n">sample_triples_ratio</span><span class="p">,</span> <span class="n">separator</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;rdflib&quot;</span><span class="p">:</span>
            <span class="c1"># Lazy import</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">rdflib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Graph</span>
            <span class="k">assert</span> <span class="n">dformat</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ttl&quot;</span><span class="p">,</span> <span class="s2">&quot;owl&quot;</span><span class="p">,</span> <span class="s2">&quot;nt&quot;</span><span class="p">,</span> <span class="s2">&quot;turtle&quot;</span><span class="p">,</span> <span class="s2">&quot;rdf/xml&quot;</span><span class="p">,</span> <span class="s2">&quot;n3&quot;</span><span class="p">,</span> <span class="s2">&quot; n-triples&quot;</span><span class="p">],</span>\
                <span class="sa">f</span><span class="s2">&quot;--backend </span><span class="si">{</span><span class="n">backend</span><span class="si">}</span><span class="s2"> and dataformat **</span><span class="si">{</span><span class="n">dformat</span><span class="si">}</span><span class="s2">** is not matching. Use --backend pandas&quot;</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data_path</span><span class="p">)],</span>
                                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;relation&#39;</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;--backend </span><span class="si">{</span><span class="n">backend</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s1"> is not matching&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s1"> could not found!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="count_triples">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.count_triples">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">count_triples</span><span class="p">(</span><span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the total number of triples in the triple store.&quot;&quot;&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/sparql-results+json&quot;</span>
    <span class="p">}</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    SELECT (COUNT(*) AS ?count)</span>
<span class="s2">    WHERE { ?s ?p ?o . }</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">},</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;results&quot;</span><span class="p">][</span><span class="s2">&quot;bindings&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">count</span></div>



<div class="viewcode-block" id="fetch_worker">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.fetch_worker">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_worker</span><span class="p">(</span><span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offsets</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Worker process: fetch assigned chunks and save to disk with per-worker tqdm.&quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Read Triple Store. Worker </span><span class="si">{</span><span class="n">worker_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="n">worker_id</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/sparql-results+json&quot;</span>
        <span class="p">}</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT ?subject ?predicate ?object</span>
<span class="s2">        WHERE </span><span class="se">{{</span>
<span class="s2">            ?subject ?predicate ?object .</span>
<span class="s2">        </span><span class="se">}}</span>
<span class="s2">        LIMIT </span><span class="si">{</span><span class="n">chunk_size</span><span class="si">}</span><span class="s2"> OFFSET </span><span class="si">{</span><span class="n">offset</span><span class="si">}</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">},</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Worker </span><span class="si">{</span><span class="n">worker_id</span><span class="si">}</span><span class="s2">] Query failed at offset </span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">bindings</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;results&quot;</span><span class="p">][</span><span class="s2">&quot;bindings&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bindings</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">triples</span> <span class="o">=</span> <span class="p">[[</span><span class="n">b</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="s2">&quot;predicate&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bindings</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">triples</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">,</span> <span class="s2">&quot;relation&quot;</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;chunk_</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s2">.parquet&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>



<div class="viewcode-block" id="read_from_triple_store_with_polars">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.read_from_triple_store_with_polars">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_from_triple_store_with_polars</span><span class="p">(</span><span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500000</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;triples_parquet&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main function to read all triples in parallel, save as Parquet, and load into Polars dataframe.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.parquet&quot;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*** Found parquet files in folder `</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">`, will read from those. Otherwise, delete the folder.***</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">parquet_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
            <span class="n">df_polars</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">parquet_files</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df_polars</span>
    
    <span class="n">total_triples</span> <span class="o">=</span> <span class="n">count_triples</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>
    <span class="n">total_chunks</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_triples</span> <span class="o">+</span> <span class="n">chunk_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">chunk_size</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total triples: </span><span class="si">{</span><span class="n">total_triples</span><span class="si">}</span><span class="s2">, total chunks: </span><span class="si">{</span><span class="n">total_chunks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Determine number of workers</span>
    <span class="n">num_workers</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cpu_count</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">num_workers</span><span class="si">}</span><span class="s2"> worker processes.&quot;</span><span class="p">)</span>

    <span class="c1"># Generate all offsets</span>
    <span class="n">all_offsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">chunk_size</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_chunks</span><span class="p">)]</span>

    <span class="c1"># Assign chunks deterministically to each worker</span>
    <span class="n">worker_offsets</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_workers</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_offsets</span><span class="p">):</span>
        <span class="n">worker_offsets</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">num_workers</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>

    <span class="c1"># Launch worker processes</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">worker_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_workers</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">fetch_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">worker_offsets</span><span class="p">[</span><span class="n">worker_id</span><span class="p">],</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">))</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="c1"># Wait for all workers to finish</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="c1"># Read all Parquet chunks into a single Polars dataframe</span>
    <span class="n">parquet_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.parquet&quot;</span><span class="p">)])</span>
    <span class="n">df_polars</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">parquet_files</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_polars</span></div>


<div class="viewcode-block" id="read_from_triple_store_with_pandas">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.read_from_triple_store_with_pandas">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_from_triple_store_with_pandas</span><span class="p">(</span><span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Read triples from triple store into pandas dataframe &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">endpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/sparql-results+json&quot;</span>
        <span class="p">}</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    SELECT ?subject ?predicate ?object</span>
<span class="s2">    WHERE {{</span>
<span class="s2">        ?subject ?predicate ?object .</span>
<span class="s2">    }}</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">},</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">ok</span>
    <span class="c1"># Generator</span>
    <span class="n">triples</span> <span class="o">=</span> <span class="p">([</span><span class="n">triple</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">triple</span><span class="p">[</span><span class="s1">&#39;predicate&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">triple</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">triple</span> <span class="ow">in</span>
               <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;bindings&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">triples</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">,</span> <span class="s2">&quot;relation&quot;</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_er_vocab">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.get_er_vocab">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_er_vocab</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="c1"># head entity and relation</span>
    <span class="n">er_vocab</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">triple</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">triple</span>
        <span class="n">er_vocab</span><span class="p">[(</span><span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">file_path</span><span class="p">:</span>
        <span class="n">save_pickle</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">er_vocab</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">er_vocab</span></div>



<div class="viewcode-block" id="get_re_vocab">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.get_re_vocab">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_re_vocab</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="c1"># head entity and relation</span>
    <span class="n">re_vocab</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">triple</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">re_vocab</span><span class="p">[(</span><span class="n">triple</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">triple</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">triple</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">file_path</span><span class="p">:</span>
        <span class="n">save_pickle</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">re_vocab</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">re_vocab</span></div>



<div class="viewcode-block" id="get_ee_vocab">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.get_ee_vocab">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_ee_vocab</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="c1"># head entity and relation</span>
    <span class="n">ee_vocab</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">triple</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">ee_vocab</span><span class="p">[(</span><span class="n">triple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">triple</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">triple</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">file_path</span><span class="p">:</span>
        <span class="n">save_pickle</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ee_vocab</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ee_vocab</span></div>



<div class="viewcode-block" id="create_constraints">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.create_constraints">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_constraints</span><span class="p">(</span><span class="n">triples</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    (1) Extract domains and ranges of relations</span>
<span class="sd">    (2) Store a mapping from relations to entities that are outside of the domain and range.</span>
<span class="sd">    Crete constrainted entities based on the range of relations</span>
<span class="sd">    :param triples:</span>
<span class="sd">    :return:</span>
<span class="sd">    Tuple[dict, dict]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">triples</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">triples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="c1"># (1) Compute the range and domain of each relation</span>
    <span class="n">range_constraints_per_rel</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">domain_constraints_per_rel</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">set_of_entities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">set_of_relations</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">e2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">triples</span><span class="p">:</span>
        <span class="n">range_constraints_per_rel</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">e2</span><span class="p">)</span>
        <span class="n">domain_constraints_per_rel</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>
        <span class="n">set_of_entities</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>
        <span class="n">set_of_relations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">set_of_entities</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">e2</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">set_of_relations</span><span class="p">:</span>
        <span class="n">range_constraints_per_rel</span><span class="p">[</span><span class="n">rel</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">set_of_entities</span> <span class="o">-</span> <span class="n">range_constraints_per_rel</span><span class="p">[</span><span class="n">rel</span><span class="p">])</span>
        <span class="n">domain_constraints_per_rel</span><span class="p">[</span><span class="n">rel</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">set_of_entities</span> <span class="o">-</span> <span class="n">domain_constraints_per_rel</span><span class="p">[</span><span class="n">rel</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">file_path</span><span class="p">:</span>
        <span class="n">save_pickle</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="n">domain_constraints_per_rel</span><span class="p">,</span> <span class="n">range_constraints_per_rel</span><span class="p">),</span> <span class="n">file_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">domain_constraints_per_rel</span><span class="p">,</span> <span class="n">range_constraints_per_rel</span></div>



<div class="viewcode-block" id="load_with_pandas">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.load_with_pandas">[docs]</a>
<span class="nd">@timeit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_with_pandas</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Deserialize data &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Deserialization Path: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">deserialize_flag</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[1 / 4] Deserializing compressed entity integer mapping...&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">entity_to_idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">deserialize_flag</span> <span class="o">+</span> <span class="s1">&#39;/entity_to_idx.gzip&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done !</span><span class="se">\t</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> seconds</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">num_entities</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">entity_to_idx</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[2 / ] Deserializing compressed relation integer mapping...&#39;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">relation_to_idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">deserialize_flag</span> <span class="o">+</span> <span class="s1">&#39;/relation_to_idx.gzip&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done !</span><span class="se">\t</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> seconds</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">num_relations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">relation_to_idx</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s1">&#39;[3 / 4] Converting integer and relation mappings &#39;</span>
        <span class="s1">&#39;from from pandas dataframe to dictionaries for an easy access...&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">entity_to_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">entity_to_idx</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s1">&#39;entity&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">relation_to_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">relation_to_idx</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s1">&#39;relation&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done !</span><span class="se">\t</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> seconds</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># 10. Serialize (9).</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[4 / 4] Deserializing integer mapped data and mapping it to numpy ndarray...&#39;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">train_set</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">deserialize_flag</span> <span class="o">+</span> <span class="s1">&#39;/idx_train_df.gzip&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done !</span><span class="se">\t</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> seconds</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[5 / 4] Deserializing integer mapped data and mapping it to numpy ndarray...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">valid_set</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">deserialize_flag</span> <span class="o">+</span> <span class="s1">&#39;/idx_valid_df.gzip&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No valid data found!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">valid_set</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># pd.DataFrame()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[6 / 4] Deserializing integer mapped data and mapping it to numpy ndarray...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">test_set</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">deserialize_flag</span> <span class="o">+</span> <span class="s1">&#39;/idx_test_df.gzip&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No test data found</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">test_set</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">eval_model</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">valid_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">test_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># 16. Create a bijection mapping from subject-relation pairs to tail entities.</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">train_set</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">valid_set</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">test_set</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">train_set</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[7 / 4] Creating er,re, and ee type vocabulary for evaluation...&#39;</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">er_vocab</span> <span class="o">=</span> <span class="n">get_er_vocab</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">re_vocab</span> <span class="o">=</span> <span class="n">get_re_vocab</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># 17. Create a bijection mapping from subject-object pairs to relations.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">ee_vocab</span> <span class="o">=</span> <span class="n">get_ee_vocab</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">domain_constraints_per_rel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">range_constraints_per_rel</span> <span class="o">=</span> <span class="n">create_constraints</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">train_set</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done !</span><span class="se">\t</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> seconds</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="save_numpy_ndarray">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.save_numpy_ndarray">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_numpy_ndarray</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">assert</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>



<div class="viewcode-block" id="load_numpy_ndarray">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.load_numpy_ndarray">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_numpy_ndarray</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>



<div class="viewcode-block" id="save_pickle">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.save_pickle">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_pickle</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span></div>



<div class="viewcode-block" id="load_pickle">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.load_pickle">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_pickle</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_recipriocal_triples">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.create_recipriocal_triples">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_recipriocal_triples</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add inverse triples into dask dataframe</span>
<span class="sd">    :param x:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;subject&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">x</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;_inverse&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;relation&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">x</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">))],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>




<div class="viewcode-block" id="dataset_sanity_checking">
<a class="viewcode-back" href="../../../autoapi/dicee/read_preprocess_save_load_kg/util/index.html#dicee.read_preprocess_save_load_kg.util.dataset_sanity_checking">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">dataset_sanity_checking</span><span class="p">(</span><span class="n">train_set</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">num_entities</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_relations</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    :param train_set:</span>
<span class="sd">    :param num_entities:</span>
<span class="sd">    :param num_relations:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">train_set</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">train_set</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">assert</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;Size of the training dataset must be greater than 0.&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">num_entities</span> <span class="o">&gt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">train_set</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="n">num_entities</span> <span class="o">&gt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">train_set</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Entity Indexing Error:</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;Max ID of a subject or object entity in train set:&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">train_set</span><span class="p">[:,</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s1"> or </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">train_set</span><span class="p">[:,</span><span class="w"> </span><span class="mi">2</span><span class="p">])</span><span class="si">}</span><span class="s1"> is greater than num_entities:</span><span class="si">{</span><span class="n">num_entities</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">num_relations</span> <span class="o">&gt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">train_set</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Relation Indexing Error:</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;Max ID of a relation in train set:</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">train_set</span><span class="p">[:,</span><span class="w"> </span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s1"> is greater than num_entities:</span><span class="si">{</span><span class="n">num_relations</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># 13. Sanity checking: data types</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">train_set</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Caglar Demir.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>